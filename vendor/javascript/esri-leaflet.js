// esri-leaflet@3.0.13 downloaded from https://ga.jspm.io/npm:esri-leaflet@3.0.13/src/EsriLeaflet.js

import{c as t,a as e,R as i,g as s,i as r,r as n,e as a,w as h,_ as u,b as p,d as c,p as m,s as d,f,h as _,j as v}from"../_/DwevRxUU.js";export{S as Support,E as Util,k as get,o as options,x as post,l as request}from"../_/DwevRxUU.js";import{Class as y,Util as g,latLng as b,point as A,Evented as I,TileLayer as L,DomEvent as T,CRS as R,ImageOverlay as C,DomUtil as w,Layer as F,popup as P,bounds as O,Browser as G,Point as M,Bounds as z,latLngBounds as q,LatLngBounds as D,GeoJSON as Z,Path as B}from"leaflet";import j from"tiny-binary-search";import"@terraformer/arcgis";var U={name:"esri-leaflet",description:"Leaflet plugins for consuming ArcGIS Online and ArcGIS Server services.",version:"3.0.13",author:"Patrick Arlt <parlt@esri.com> (http://patrickarlt.com)",bugs:{url:"https://github.com/esri/esri-leaflet/issues"},contributors:["Patrick Arlt <parlt@esri.com> (http://patrickarlt.com)","John Gravois (https://johngravois.com)","Gavin Rehkemper <grehkemper@esri.com> (https://gavinr.com)","Jacob Wasilkowski (https://jwasilgeo.github.io)"],dependencies:{"@terraformer/arcgis":"^2.1.0","tiny-binary-search":"^1.0.3"},devDependencies:{"@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@rollup/plugin-terser":"^0.3.0",chai:"4.3.7","chokidar-cli":"^3.0.0","gh-release":"^7.0.1","highlight.js":"^11.7.0","http-server":"^14.1.1",husky:"^1.1.1",karma:"^6.4.1","karma-chrome-launcher":"^3.1.1","karma-coverage":"^2.2.0","karma-edgium-launcher":"github:matracey/karma-edgium-launcher","karma-firefox-launcher":"^2.1.2","karma-mocha":"^2.0.1","karma-mocha-reporter":"^2.2.5","karma-safari-launcher":"~1.0.0","karma-sinon-chai":"^2.0.2","karma-sourcemap-loader":"^0.3.8",leaflet:"^1.6.0",mkdirp:"^1.0.4",mocha:"^10.2.0","npm-run-all":"^4.1.5",rollup:"^2.79.1",semistandard:"^14.2.3",sinon:"^15.0.1","sinon-chai":"3.7.0",snazzy:"^9.0.0"},files:["src/**/*.js","dist/esri-leaflet.js","dist/esri-leaflet.js.map","dist/esri-leaflet-debug.js.map","dist/siteData.json","profiles/*.js"],homepage:"https://developers.arcgis.com/esri-leaflet/",module:"src/EsriLeaflet.js","jsnext:main":"src/EsriLeaflet.js",jspm:{registry:"npm",format:"es6",main:"src/EsriLeaflet.js"},keywords:["arcgis","esri","esri leaflet","gis","leaflet plugin","mapping"],license:"Apache-2.0",main:"dist/esri-leaflet-debug.js",peerDependencies:{leaflet:"^1.0.0"},readmeFilename:"README.md",repository:{type:"git",url:"git@github.com:Esri/esri-leaflet.git"},scripts:{build:"rollup -c profiles/debug.js & rollup -c profiles/production.js",lint:"semistandard | snazzy",prebuild:"mkdirp dist",pretest:"npm run build",fix:"semistandard --fix",release:"./scripts/release.sh","start-watch":'chokidar src -c "npm run build"',start:"run-p start-watch serve",serve:"http-server -p 5000 -c-1 -o",test:"npm run lint && karma start"},semistandard:{globals:["expect","L","XMLHttpRequest","sinon","xhr","proj4"]},unpkg:"dist/esri-leaflet-debug.js",husky:{hooks:{"pre-commit":"npm run lint"}}};var N=y.extend({options:{proxy:false,useCors:t},generateSetter:function(t,e){return g.bind((function(e){this.params[t]=e;return this}),e)},initialize:function(t){if(t.request&&t.options){this._service=t;g.setOptions(this,t.options)}else{g.setOptions(this,t);this.options.url=e(t.url)}this.params=g.extend({},this.params||{});if(this.setters)for(var i in this.setters){var s=this.setters[i];this[i]=this.generateSetter(s,this)}},token:function(t){this._service?this._service.authenticate(t):this.params.token=t;return this},apikey:function(t){return this.token(t)},format:function(t){this.params.returnUnformattedValues=!t;return this},request:function(t,e){this.options.requestParams&&g.extend(this.params,this.options.requestParams);return this._service?this._service.request(this.path,this.params,t,e):this._request("request",this.path,this.params,t,e)},_request:function(t,e,s,r,o){var n=this.options.proxy?this.options.proxy+"?"+this.options.url+e:this.options.url+e;return t!=="get"&&t!=="request"||this.options.useCors?i[t](n,s,r,o):i.get.JSONP(n,s,r,o)}});function task(t){t=s(t);return new N(t)}var W=N.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"},path:"query",params:{returnGeometry:true,where:"1=1",outSR:4326,outFields:"*"},within:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelContains";return this},intersects:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelIntersects";return this},contains:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelWithin";return this},crosses:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelCrosses";return this},touches:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelTouches";return this},overlaps:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelOverlaps";return this},bboxIntersects:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelEnvelopeIntersects";return this},indexIntersects:function(t){this._setGeometryParams(t);this.params.spatialRel="esriSpatialRelIndexIntersects";return this},nearby:function(t,e){t=b(t);this.params.geometry=[t.lng,t.lat];this.params.geometryType="esriGeometryPoint";this.params.spatialRel="esriSpatialRelIntersects";this.params.units="esriSRUnit_Meter";this.params.distance=e;this.params.inSR=4326;return this},where:function(t){this.params.where=t;return this},between:function(t,e){this.params.time=[t.valueOf(),e.valueOf()];return this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());this.params.maxAllowableOffset=i/t.getSize().y*e;return this},orderBy:function(t,e){e=e||"ASC";this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"";this.params.orderByFields+=[t,e].join(" ");return this},run:function(t,e){this._cleanParams();if(this.options.isModern||r(this.options.url)&&this.options.isModern===void 0){this.params.f="geojson";return this.request((function(i,s){this._trapSQLerrors(i);t.call(e,i,s,s)}),this)}return this.request((function(i,s){this._trapSQLerrors(i);t.call(e,i,s&&n(s),s)}),this)},count:function(t,e){this._cleanParams();this.params.returnCountOnly=true;return this.request((function(e,i){t.call(this,e,i&&i.count,i)}),e)},ids:function(t,e){this._cleanParams();this.params.returnIdsOnly=true;return this.request((function(e,i){t.call(this,e,i&&i.objectIds,i)}),e)},bounds:function(t,e){this._cleanParams();this.params.returnExtentOnly=true;return this.request((function(i,s){if(s&&s.extent&&a(s.extent))t.call(e,i,a(s.extent),s);else{i={message:"Invalid Bounds"};t.call(e,i,null,s)}}),e)},distinct:function(){this.params.returnGeometry=false;this.params.returnDistinctValues=true;return this},pixelSize:function(t){var e=A(t);this.params.pixelSize=[e.x,e.y];return this},layer:function(t){this.path=t+"/query";return this},_trapSQLerrors:function(t){t&&t.code==="400"&&h("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams:function(){delete this.params.returnIdsOnly;delete this.params.returnExtentOnly;delete this.params.returnCountOnly},_setGeometryParams:function(t){this.params.inSR=4326;var e=u(t);this.params.geometry=e.geometry;this.params.geometryType=e.geometryType}});function query(t){return new W(t)}var V=N.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:true,returnGeometry:true,returnZ:true,returnM:false},layerDefs:function(t,e){this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"";this.params.layerDefs+=[t,e].join(":");return this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());this.params.maxAllowableOffset=i/t.getSize().y*e;return this},run:function(t,e){return this.request((function(i,s){t.call(e,i,s&&n(s),s)}),e)}});function find(t){return new V(t)}var Q=N.extend({path:"identify",between:function(t,e){this.params.time=[t.valueOf(),e.valueOf()];return this}});function identify(t){return new Q(t)}var J=Q.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:true},on:function(t){var e=p(t.getBounds());var i=t.getSize();this.params.imageDisplay=[i.x,i.y,96];this.params.mapExtent=[e.xmin,e.ymin,e.xmax,e.ymax];return this},at:function(t){t.length===2&&(t=b(t));this._setGeometryParams(t);return this},layerDef:function(t,e){this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"";this.params.layerDefs+=[t,e].join(":");return this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());this.params.maxAllowableOffset=i/t.getSize().y*e;return this},run:function(t,e){return this.request((function(i,s){if(i)t.call(e,i,void 0,s);else{var r=n(s);s.results=s.results.reverse();for(var o=0;o<r.features.length;o++){var a=r.features[o];a.layerId=s.results[o].layerId}t.call(e,void 0,r,s)}}))},_setGeometryParams:function(t){var e=u(t);this.params.geometry=e.geometry;this.params.geometryType=e.geometryType}});function identifyFeatures(t){return new J(t)}var K=Q.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:false},at:function(t){t=b(t);this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}});this.params.geometryType="esriGeometryPoint";return this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(t,e){return this.request((function(i,s){t.call(e,i,s&&this._responseToGeoJSON(s),s)}),this)},_responseToGeoJSON:function(t){var e=t.location;var i=t.catalogItems;var s=t.catalogItemVisibilities;var r={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[e.x,e.y]},crs:{type:"EPSG",properties:{code:e.spatialReference.wkid}},properties:{OBJECTID:t.objectId,name:t.name,value:t.value},id:t.objectId}};t.properties&&t.properties.Values&&(r.pixel.properties.values=t.properties.Values);if(i&&i.features){r.catalogItems=n(i);if(s&&s.length===r.catalogItems.features.length)for(var o=s.length-1;o>=0;o--)r.catalogItems.features[o].properties.catalogItemVisibility=s[o]}return r}});function identifyImage(t){return new K(t)}var X=I.extend({options:{proxy:false,useCors:t,timeout:0},initialize:function(t){t=t||{};this._requestQueue=[];this._authenticating=false;g.setOptions(this,t);this.options.url=e(this.options.url)},get:function(t,e,i,s){return this._request("get",t,e,i,s)},post:function(t,e,i,s){return this._request("post",t,e,i,s)},request:function(t,e,i,s){return this._request("request",t,e,i,s)},metadata:function(t,e){return this._request("get","",{},t,e)},authenticate:function(t){this._authenticating=false;this.options.token=t;this._runQueue();return this},getTimeout:function(){return this.options.timeout},setTimeout:function(t){this.options.timeout=t},_request:function(t,e,s,r,o){this.fire("requeststart",{url:this.options.url+e,params:s,method:t},true);var n=this._createServiceCallback(t,e,s,r,o);this.options.token&&(s.token=this.options.token);this.options.requestParams&&g.extend(s,this.options.requestParams);if(!this._authenticating){var a=this.options.proxy?this.options.proxy+"?"+this.options.url+e:this.options.url+e;return t!=="get"&&t!=="request"||this.options.useCors?i[t](a,s,n,o):i.get.JSONP(a,s,n,o)}this._requestQueue.push([t,e,s,r,o])},_createServiceCallback:function(t,e,i,s,r){return g.bind((function(o,n){if(o&&(o.code===499||o.code===498)){this._authenticating=true;this._requestQueue.push([t,e,i,s,r]);this.fire("authenticationrequired",{authenticate:g.bind(this.authenticate,this)},true);o.authenticate=g.bind(this.authenticate,this)}s.call(r,o,n);o?this.fire("requesterror",{url:this.options.url+e,params:i,message:o.message,code:o.code,method:t},true):this.fire("requestsuccess",{url:this.options.url+e,params:i,response:n,method:t},true);this.fire("requestend",{url:this.options.url+e,params:i,method:t},true)}),this)},_runQueue:function(){for(var t=this._requestQueue.length-1;t>=0;t--){var e=this._requestQueue[t];var i=e.shift();this[i].apply(this,e)}this._requestQueue=[]}});function service(t){t=s(t);return new X(t)}var H=X.extend({identify:function(){return identifyFeatures(this)},find:function(){return find(this)},query:function(){return query(this)}});function mapService(t){return new H(t)}var Y=X.extend({query:function(){return query(this)},identify:function(){return identifyImage(this)}});function imageService(t){return new Y(t)}var $=X.extend({options:{idAttribute:"OBJECTID"},query:function(){return query(this)},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,e,i){var s=t.features?t.features:[t];for(var r=s.length-1;r>=0;r--)delete s[r].id;t=c(t);t=s.length>1?t:[t];return this.post("addFeatures",{features:t},(function(t,s){var r=s&&s.addResults?s.addResults.length>1?s.addResults:s.addResults[0]:void 0;e&&e.call(i,t||s.addResults[0].error,r)}),i)},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var s=t.features?t.features:[t];t=c(t,this.options.idAttribute);t=s.length>1?t:[t];return this.post("updateFeatures",{features:t},(function(t,s){var r=s&&s.updateResults?s.updateResults.length>1?s.updateResults:s.updateResults[0]:void 0;e&&e.call(i,t||s.updateResults[0].error,r)}),i)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.post("deleteFeatures",{objectIds:t},(function(t,s){var r=s&&s.deleteResults?s.deleteResults.length>1?s.deleteResults:s.deleteResults[0]:void 0;e&&e.call(i,t||s.deleteResults[0].error,r)}),i)}});function featureLayerService(t){return new $(t)}var tt=window.location.protocol!=="https:"?"http:":"https:";var et=L.extend({statics:{TILES:{Streets:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map"}},Topographic:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map"}},Oceans:{urlTemplate:tt+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap"}},OceansLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},NationalGeographic:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp."}},DarkGray:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},DarkGrayLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},Gray:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},GrayLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},Imagery:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community",attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}},ImageryLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},ImageryTransportation:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},ShadedRelief:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS"}},ShadedReliefLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:12,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},Terrain:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS, NOAA"}},TerrainLabels:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],pane:m?"esri-labels":"tilePane",attribution:""}},USATopo:{urlTemplate:tt+"//{s}.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:15,subdomains:["server","services"],attribution:"USGS, National Geographic Society, i-cubed"}},ImageryClarity:{urlTemplate:tt+"//clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"}},Physical:{urlTemplate:tt+"//{s}.arcgisonline.com/arcgis/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:8,subdomains:["server","services"],attribution:"U.S. National Park Service"}},ImageryFirefly:{urlTemplate:tt+"//fly.maptiles.arcgis.com/arcgis/rest/services/World_Imagery_Firefly/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community",attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}}}},initialize:function(t,e){var i;if(typeof t==="object"&&t.urlTemplate&&t.options)i=t;else{if(typeof t!=="string"||!et.TILES[t])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Physical", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ImageryClarity", "ImageryFirefly", ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');i=et.TILES[t]}var s=g.extend(i.options,e);g.setOptions(this,s);this.options.ignoreDeprecationWarning||console.warn("WARNING: L.esri.BasemapLayer uses data services that are in mature support and are not being updated. Please use L.esri.Vector.vectorBasemapLayer instead. More info: https://esriurl.com/esri-leaflet-basemap");this.options.token&&i.urlTemplate.indexOf("token=")===-1&&(i.urlTemplate+="?token="+this.options.token);this.options.proxy&&(i.urlTemplate=this.options.proxy+"?"+i.urlTemplate);L.prototype.initialize.call(this,i.urlTemplate,s)},onAdd:function(t){d(t);this.options.pane==="esri-labels"&&this._initPane();this.options.attributionUrl&&f((this.options.proxy?this.options.proxy+"?":"")+this.options.attributionUrl,t);t.on("moveend",_);L.prototype.onAdd.call(this,t)},onRemove:function(t){v(t);t.off("moveend",_);L.prototype.onRemove.call(this,t)},_initPane:function(){if(!this._map.getPane(this.options.pane)){var t=this._map.createPane(this.options.pane);t.style.pointerEvents="none";t.style.zIndex=500}},getAttribution:function(){if(this.options.attribution)var t='<span class="esri-dynamic-attribution">'+this.options.attribution+"</span>";return t}});function basemapLayer(t,e){return new et(t,e)}var it=L.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=="},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(t){t=g.setOptions(this,t);t=s(t);this.tileUrl=(t.proxy?t.proxy+"?":"")+t.url+"tile/{z}/{y}/{x}"+(t.requestParams&&Object.keys(t.requestParams).length>0?g.getParamString(t.requestParams):"");t.url.indexOf("{s}")!==-1&&t.subdomains&&(t.url=t.url.replace("{s}",t.subdomains[0]));this.service=mapService(t);this.service.addEventParent(this);var e=new RegExp(/tiles.arcgis(online)?\.com/g);if(e.test(t.url)){this.tileUrl=this.tileUrl.replace("://tiles","://tiles{s}");t.subdomains=["1","2","3","4"]}this.options.token&&(this.tileUrl+="?token="+this.options.token);L.prototype.initialize.call(this,this.tileUrl,t)},getTileUrl:function(t){var e=this._getZoomForUrl();return g.template(this.tileUrl,g.extend({s:this._getSubdomain(t),x:t.x,y:t.y,z:this._lodMap&&this._lodMap[e]!==void 0?this._lodMap[e]:e},this.options))},createTile:function(t,e){var i=document.createElement("img");T.on(i,"load",g.bind(this._tileOnLoad,this,e,i));T.on(i,"error",g.bind(this._tileOnError,this,e,i));this.options.crossOrigin&&(i.crossOrigin="");i.alt="";!this._lodMap||this._lodMap&&this._lodMap[this._getZoomForUrl()]!==void 0?i.src=this.getTileUrl(t):this.once("lodmap",(function(){i.src=this.getTileUrl(t)}),this);return i},onAdd:function(t){d(t);this._lodMap||this.metadata((function(e,i){if(!e&&i.spatialReference){var s=i.spatialReference.latestWkid||i.spatialReference.wkid;if(!this.options.attribution&&t.attributionControl&&i.copyrightText){this.options.attribution=i.copyrightText;t.attributionControl.addAttribution(this.getAttribution())}if(t.options.crs!==R.EPSG3857||s!==102100&&s!==3857)t.options.crs&&t.options.crs.code&&t.options.crs.code.indexOf(s)>-1||h("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet https://developers.arcgis.com/esri-leaflet/samples/non-mercator-projection/");else{this._lodMap={};var r=i.tileInfo.lods;var o=it.MercatorZoomLevels;for(var n=0;n<r.length;n++){var a=r[n];for(var l in o){var u=o[l];if(this._withinPercentage(a.resolution,u,this.options.zoomOffsetAllowance)){this._lodMap[l]=a.level;break}}}this.fire("lodmap")}}}),this);L.prototype.onAdd.call(this,t)},onRemove:function(t){v(t);L.prototype.onRemove.call(this,t)},metadata:function(t,e){this.service.metadata(t,e);return this},identify:function(){return this.service.identify()},find:function(){return this.service.find()},query:function(){return this.service.query()},authenticate:function(t){var e="?token="+t;this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,e):this.tileUrl+e;this.options.token=t;this.service.authenticate(t);return this},_withinPercentage:function(t,e,i){var s=Math.abs(t/e-1);return s<i}});function tiledMapLayer(t,e){return new it(t,e)}var st=C.extend({onAdd:function(t){this._topLeft=t.getPixelBounds().min;C.prototype.onAdd.call(this,t)},_reset:function(){this._map.options.crs===R.EPSG3857?C.prototype._reset.call(this):w.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}});var rt=F.extend({options:{opacity:1,position:"front",f:"image",useCors:t,attribution:null,interactive:false,alt:""},onAdd:function(t){d(t);this.options.zIndex&&(this.options.position=null);this._update=g.throttle(this._update,this.options.updateInterval,this);t.on("moveend",this._update,this);if(this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds()))t.addLayer(this._currentImage);else if(this._currentImage){this._map.removeLayer(this._currentImage);this._currentImage=null}this._update();if(this._popup){this._map.on("click",this._getPopupData,this);this._map.on("dblclick",this._resetPopupState,this)}this.metadata((function(e,i){if(!e&&!this.options.attribution&&t.attributionControl&&i.copyrightText){this.options.attribution=i.copyrightText;t.attributionControl.addAttribution(this.getAttribution())}}),this)},onRemove:function(t){v(t);this._currentImage&&this._map.removeLayer(this._currentImage);if(this._popup){this._map.off("click",this._getPopupData,this);this._map.off("dblclick",this._resetPopupState,this)}this._map.off("moveend",this._update,this)},bindPopup:function(t,e){this._shouldRenderPopup=false;this._lastClick=false;this._popup=P(e);this._popupFunction=t;if(this._map){this._map.on("click",this._getPopupData,this);this._map.on("dblclick",this._resetPopupState,this)}return this},unbindPopup:function(){if(this._map){this._map.closePopup(this._popup);this._map.off("click",this._getPopupData,this);this._map.off("dblclick",this._resetPopupState,this)}this._popup=false;return this},bringToFront:function(){this.options.position="front";if(this._currentImage){this._currentImage.bringToFront();this._setAutoZIndex(Math.max)}return this},bringToBack:function(){this.options.position="back";if(this._currentImage){this._currentImage.bringToBack();this._setAutoZIndex(Math.min)}return this},setZIndex:function(t){this.options.zIndex=t;this._currentImage&&this._currentImage.setZIndex(t);return this},_setAutoZIndex:function(t){if(this._currentImage){var e=this._currentImage.getPane().children;var i=-t(-Infinity,Infinity);for(var s,r=0,o=e.length;r<o;r++){s=e[r].style.zIndex;e[r]!==this._currentImage._image&&s&&(i=t(i,+s))}if(isFinite(i)){this.options.zIndex=i+t(-1,1);this.setZIndex(this.options.zIndex)}}},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(t){this.options.opacity=t;this._currentImage&&this._currentImage.setOpacity(t);return this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e){this.options.from=t;this.options.to=e;this._update();return this},metadata:function(t,e){this.service.metadata(t,e);return this},authenticate:function(t){this.service.authenticate(t);return this},redraw:function(){this._update()},_renderImage:function(t,e,i){if(this._map){i&&(t="data:"+i+";base64,"+t);if(!t)return;var s=new st(t,e,{opacity:0,crossOrigin:this.options.withCredentials?"use-credentials":this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive}).addTo(this._map);var onOverlayError=function(){this._map.removeLayer(s);this.fire("error");s.off("load",onOverlayLoad,this)};var onOverlayLoad=function(t){s.off("error",onOverlayError,this);if(this._map){var i=t.target;var r=this._currentImage;if(i._bounds.equals(e)&&i._bounds.equals(this._map.getBounds())){this._currentImage=i;this.options.position==="front"?this.bringToFront():this.options.position==="back"&&this.bringToBack();this.options.zIndex&&this.setZIndex(this.options.zIndex);this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage);r&&this._map&&this._map.removeLayer(r);r&&r._map&&r._map.removeLayer(r)}else this._map.removeLayer(i)}this.fire("load",{bounds:e})};s.once("error",onOverlayError,this);s.once("load",onOverlayLoad,this)}},_update:function(){if(this._map){var t=this._map.getZoom();var e=this._map.getBounds();if(!this._animatingZoom&&(!this._map._panTransition||!this._map._panTransition._inProgress))if(t>this.options.maxZoom||t<this.options.minZoom){if(this._currentImage){this._currentImage._map.removeLayer(this._currentImage);this._currentImage=null}}else{var i=this._buildExportParams();g.extend(i,this.options.requestParams);if(i){this._requestExport(i,e);this.fire("loading",{bounds:e})}else if(this._currentImage){this._currentImage._map.removeLayer(this._currentImage);this._currentImage=null}}}},_renderPopup:function(t,e,i,s){t=b(t);if(this._shouldRenderPopup&&this._lastClick.equals(t)){var r=this._popupFunction(e,i,s);r&&this._popup.setLatLng(t).setContent(r).openOn(this._map)}},_resetPopupState:function(t){this._shouldRenderPopup=false;this._lastClick=t.latlng},_calculateBbox:function(){var t=this._map.getPixelBounds();var e=this._map.unproject(t.getBottomLeft());var i=this._map.unproject(t.getTopRight());var s=this._map.options.crs.project(i);var r=this._map.options.crs.project(e);var o=O(s,r);return[o.getBottomLeft().x,o.getBottomLeft().y,o.getTopRight().x,o.getTopRight().y].join(",")},_calculateImageSize:function(){var t=this._map.getPixelBounds();var e=this._map.getSize();var i=this._map.unproject(t.getBottomLeft());var s=this._map.unproject(t.getTopRight());var r=this._map.latLngToLayerPoint(s).y;var o=this._map.latLngToLayerPoint(i).y;(r>0||o<e.y)&&(e.y=o-r);return e.x+","+e.y}});var ot=rt.extend({options:{updateInterval:150,format:"jpgpng",transparent:true,f:"image"},query:function(){return this.service.query()},identify:function(){return this.service.identify()},initialize:function(t){t=s(t);this.service=imageService(t);this.service.addEventParent(this);g.setOptions(this,t)},setPixelType:function(t){this.options.pixelType=t;this._update();return this},getPixelType:function(){return this.options.pixelType},setBandIds:function(t){g.isArray(t)?this.options.bandIds=t.join(","):this.options.bandIds=t.toString();this._update();return this},getBandIds:function(){return this.options.bandIds},setNoData:function(t,e){g.isArray(t)?this.options.noData=t.join(","):this.options.noData=t.toString();e&&(this.options.noDataInterpretation=e);this._update();return this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(t){this.options.renderingRule=t;this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(t){this.options.mosaicRule=t;this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(t){var e=g.bind((function(e,i,s){e||setTimeout(g.bind((function(){this._renderPopup(t.latlng,e,i,s)}),this),300)}),this);var i=this.identify().at(t.latlng);this.options.mosaicRule&&i.setMosaicRule(this.options.mosaicRule);i.run(e);this._shouldRenderPopup=true;this._lastClick=t.latlng},_buildExportParams:function(){var t=parseInt(this._map.options.crs.code.split(":")[1],10);var e={bbox:this._calculateBbox(),size:this._calculateImageSize(),format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf());this.options.pixelType&&(e.pixelType=this.options.pixelType);this.options.interpolation&&(e.interpolation=this.options.interpolation);this.options.compressionQuality&&(e.compressionQuality=this.options.compressionQuality);this.options.bandIds&&(e.bandIds=this.options.bandIds);(this.options.noData===0||this.options.noData)&&(e.noData=this.options.noData);this.options.noDataInterpretation&&(e.noDataInterpretation=this.options.noDataInterpretation);this.service.options.token&&(e.token=this.service.options.token);this.options.renderingRule&&(e.renderingRule=JSON.stringify(this.options.renderingRule));this.options.mosaicRule&&(e.mosaicRule=JSON.stringify(this.options.mosaicRule));return e},_requestExport:function(t,e){if(this.options.f==="json")this.service.request("exportImage",t,(function(t,i){if(!t){this.options.token&&(i.href+="?token="+this.options.token);this.options.proxy&&(i.href=this.options.proxy+"?"+i.href);this._renderImage(i.href,e)}}),this);else{t.f="image";var i=this.options.url+"exportImage"+g.getParamString(t);this.options.proxy&&(i=this.options.proxy+"?"+i);this._renderImage(i,e)}}});function imageMapLayer(t,e){return new ot(t,e)}var nt=rt.extend({options:{updateInterval:150,layers:false,layerDefs:false,timeOptions:false,format:"png32",transparent:true,f:"json"},initialize:function(t){t=s(t);this.service=mapService(t);this.service.addEventParent(this);g.setOptions(this,t)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(t){this.options.dynamicLayers=t;this._update();return this},getLayers:function(){return this.options.layers},setLayers:function(t){this.options.layers=t;this._update();return this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(t){this.options.layerDefs=t;this._update();return this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(t){this.options.timeOptions=t;this._update();return this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},_getPopupData:function(t){var e=g.bind((function(e,i,s){e||setTimeout(g.bind((function(){this._renderPopup(t.latlng,e,i,s)}),this),300)}),this);var i;i=this.options.popup?this.options.popup.on(this._map).at(t.latlng):this.identify().on(this._map).at(t.latlng);i.params.maxAllowableOffset||i.simplify(this._map,.5);this.options.popup&&this.options.popup.params&&this.options.popup.params.layers||(this.options.layers?i.layers("visible:"+this.options.layers.join(",")):i.layers("visible"));if(this.options.layerDefs&&typeof this.options.layerDefs!=="string"&&!i.params.layerDefs)for(var s in this.options.layerDefs)Object.prototype.hasOwnProperty.call(this.options.layerDefs,s)&&i.layerDef(s,this.options.layerDefs[s]);i.run(e);this._shouldRenderPopup=true;this._lastClick=t.latlng},_buildExportParams:function(){var t=parseInt(this._map.options.crs.code.split(":")[1],10);var e={bbox:this._calculateBbox(),size:this._calculateImageSize(),dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};this.options.dynamicLayers&&(e.dynamicLayers=this.options.dynamicLayers);if(this.options.layers){if(this.options.layers.length===0)return;e.layers="show:"+this.options.layers.join(",")}this.options.layerDefs&&(e.layerDefs=typeof this.options.layerDefs==="string"?this.options.layerDefs:JSON.stringify(this.options.layerDefs));this.options.timeOptions&&(e.timeOptions=JSON.stringify(this.options.timeOptions));this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf());this.service.options.token&&(e.token=this.service.options.token);this.options.proxy&&(e.proxy=this.options.proxy);this.options.disableCache&&(e._ts=Date.now());return e},_requestExport:function(t,e){if(this.options.f==="json")this.service.request("export",t,(function(t,i){if(!t){this.options.token&&i.href&&(i.href+="?token="+this.options.token);this.options.proxy&&i.href&&(i.href=this.options.proxy+"?"+i.href);i.href?this._renderImage(i.href,e):this._renderImage(i.imageData,e,i.contentType)}}),this);else{t.f="image";var i=this.options.url+"export"+g.getParamString(t);this.options.proxy&&(i=this.options.proxy+"?"+i);this._renderImage(i,e)}}});function dynamicMapLayer(t,e){return new nt(t,e)}var at=F.extend({options:{cellSize:512,updateWhenIdle:G.mobile,updateInterval:150,noWrap:false,keepBuffer:1.5},initialize:function(t){g.setOptions(this,t)},onAdd:function(t){this._cells={};this._activeCells={};this._resetView();this._update()},onRemove:function(t){this._removeAllCells();this._cellZoom=void 0},isLoading:function(){return this._loading},redraw:function(){if(this._map){this._removeAllCells();this._update()}return this},getEvents:function(){var t={viewprereset:this._invalidateAll,viewreset:this._resetView,zoom:this._resetView,moveend:this._onMoveEnd};if(!this.options.updateWhenIdle){this._onMove||(this._onMove=g.throttle(this._onMoveEnd,this.options.updateInterval,this));t.move=this._onMove}return t},createCell:function(){return document.createElement("div")},removeCell:function(){},reuseCell:function(){},cellLeave:function(){},cellEnter:function(){},getCellSize:function(){var t=this.options.cellSize;return t instanceof M?t:new M(t,t)},_pruneCells:function(){if(this._map){var t,e;for(t in this._cells){e=this._cells[t];e.retain=e.current}for(t in this._cells){e=this._cells[t];if(e.current&&!e.active){var i=e.coords;this._retainParent(i.x,i.y,i.z,i.z-5)||this._retainChildren(i.x,i.y,i.z,i.z+2)}}for(t in this._cells)this._cells[t].retain||this._removeCell(t)}},_removeAllCells:function(){for(var t in this._cells)this._removeCell(t)},_invalidateAll:function(){this._removeAllCells();this._cellZoom=void 0},_retainParent:function(t,e,i,s){var r=Math.floor(t/2);var o=Math.floor(e/2);var n=i-1;var a=new M(+r,+o);a.z=+n;var l=this._cellCoordsToKey(a);var h=this._cells[l];if(h&&h.active){h.retain=true;return true}h&&h.loaded&&(h.retain=true);return n>s&&this._retainParent(r,o,n,s)},_retainChildren:function(t,e,i,s){for(var r=2*t;r<2*t+2;r++)for(var o=2*e;o<2*e+2;o++){var n=new M(r,o);n.z=i+1;var a=this._cellCoordsToKey(n);var l=this._cells[a];if(l&&l.active)l.retain=true;else{l&&l.loaded&&(l.retain=true);i+1<s&&this._retainChildren(r,o,i+1,s)}}},_resetView:function(t){var e=t&&(t.pinch||t.flyTo);e||this._setView(this._map.getCenter(),this._map.getZoom(),e,e)},_setView:function(t,e,i,s){var r=Math.round(e);if(!s){this._cellZoom=r;this._abortLoading&&this._abortLoading();this._resetGrid();r!==void 0&&this._update(t);i||this._pruneCells();this._noPrune=!!i}},_resetGrid:function(){var t=this._map;var e=t.options.crs;var i=this._cellSize=this.getCellSize();var s=this._cellZoom;var r=this._map.getPixelWorldBounds(this._cellZoom);r&&(this._globalCellRange=this._pxBoundsToCellRange(r));this._wrapX=e.wrapLng&&!this.options.noWrap&&[Math.floor(t.project([0,e.wrapLng[0]],s).x/i.x),Math.ceil(t.project([0,e.wrapLng[1]],s).x/i.y)];this._wrapY=e.wrapLat&&!this.options.noWrap&&[Math.floor(t.project([e.wrapLat[0],0],s).y/i.x),Math.ceil(t.project([e.wrapLat[1],0],s).y/i.y)]},_onMoveEnd:function(t){var e=t&&(t.pinch||t.flyTo);e||!this._map||this._map._animatingZoom||this._update()},_getCelldPixelBounds:function(t){var e=this._map;var i=e._animatingZoom?Math.max(e._animateToZoom,e.getZoom()):e.getZoom();var s=e.getZoomScale(i,this._cellZoom);var r=e.project(t,this._cellZoom).floor();var o=e.getSize().divideBy(s*2);return new z(r.subtract(o),r.add(o))},_update:function(t){var e=this._map;if(e){var i=Math.round(e.getZoom());t===void 0&&(t=e.getCenter());var s=this._getCelldPixelBounds(t);var r=this._pxBoundsToCellRange(s);var o=r.getCenter();var n=[];var a=this.options.keepBuffer;var l=new z(r.getBottomLeft().subtract([a,-a]),r.getTopRight().add([a,-a]));if(!(isFinite(r.min.x)&&isFinite(r.min.y)&&isFinite(r.max.x)&&isFinite(r.max.y)))throw new Error("Attempted to load an infinite number of cells");for(var h in this._cells){var u=this._cells[h].coords;u.z===this._cellZoom&&l.contains(new M(u.x,u.y))||(this._cells[h].current=false)}if(Math.abs(i-this._cellZoom)>1)this._setView(t,i);else{for(var p=r.min.y;p<=r.max.y;p++)for(var c=r.min.x;c<=r.max.x;c++){var m=new M(c,p);m.z=this._cellZoom;if(this._isValidCell(m)){var d=this._cells[this._cellCoordsToKey(m)];d?d.current=true:n.push(m)}}n.sort((function(t,e){return t.distanceTo(o)-e.distanceTo(o)}));if(n.length!==0){this._loading||(this._loading=true);for(c=0;c<n.length;c++){var f=this._cellCoordsToKey(n[c]);var _=this._keyToCellCoords(f);this._activeCells[_]?this._reuseCell(n[c]):this._createCell(n[c])}}}}},_isValidCell:function(t){var e=this._map.options.crs;if(!e.infinite){var i=this._globalCellRange;if(!e.wrapLng&&(t.x<i.min.x||t.x>i.max.x)||!e.wrapLat&&(t.y<i.min.y||t.y>i.max.y))return false}if(!this.options.bounds)return true;var s=this._cellCoordsToBounds(t);return q(this.options.bounds).overlaps(s)},_keyToBounds:function(t){return this._cellCoordsToBounds(this._keyToCellCoords(t))},_cellCoordsToNwSe:function(t){var e=this._map;var i=this.getCellSize();var s=t.scaleBy(i);var r=s.add(i);var o=e.unproject(s,t.z);var n=e.unproject(r,t.z);return[o,n]},_cellCoordsToBounds:function(t){var e=this._cellCoordsToNwSe(t);var i=new D(e[0],e[1]);this.options.noWrap||(i=this._map.wrapLatLngBounds(i));return i},_cellCoordsToKey:function(t){return t.x+":"+t.y+":"+t.z},_keyToCellCoords:function(t){var e=t.split(":");var i=new M(+e[0],+e[1]);i.z=+e[2];return i},_removeCell:function(t){var e=this._cells[t];if(e){var i=this._keyToCellCoords(t);var s=this._wrapCoords(i);var r=this._cellCoordsToBounds(this._wrapCoords(i));e.current=false;delete this._cells[t];this._activeCells[t]=e;this.cellLeave(r,s,t);this.fire("cellleave",{key:t,coords:s,bounds:r})}},_reuseCell:function(t){var e=this._cellCoordsToKey(t);this._cells[e]=this._activeCells[e];this._cells[e].current=true;var i=this._wrapCoords(t);var s=this._cellCoordsToBounds(this._wrapCoords(t));this.cellEnter(s,i,e);this.fire("cellenter",{key:e,coords:i,bounds:s})},_createCell:function(t){var e=this._cellCoordsToKey(t);var i=this._wrapCoords(t);var s=this._cellCoordsToBounds(this._wrapCoords(t));this.createCell(s,i,e);this.fire("cellcreate",{key:e,coords:i,bounds:s});this._cells[e]={coords:t,current:true};g.requestAnimFrame(this._pruneCells,this)},_cellReady:function(t,e,i){var s=this._cellCoordsToKey(t);i=this._cells[s];if(i){i.loaded=+new Date;i.active=true}},_getCellPos:function(t){return t.scaleBy(this.getCellSize())},_wrapCoords:function(t){var e=new M(this._wrapX?g.wrapNum(t.x,this._wrapX):t.x,this._wrapY?g.wrapNum(t.y,this._wrapY):t.y);e.z=t.z;return e},_pxBoundsToCellRange:function(t){var e=this.getCellSize();return new z(t.min.unscaleBy(e).floor(),t.max.unscaleBy(e).ceil().subtract([1,1]))}});var lt=at.extend({options:{attribution:null,where:"1=1",fields:["*"],from:false,to:false,timeField:false,timeFilterMode:"server",simplifyFactor:0,precision:6,fetchAllFeatures:false},initialize:function(t){at.prototype.initialize.call(this,t);t=s(t);t=g.setOptions(this,t);this.service=featureLayerService(t);this.service.addEventParent(this);if(this.options.fields[0]!=="*"){var e=false;for(var i=0;i<this.options.fields.length;i++)this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)&&(e=true);e===false&&h("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}if(this.options.timeField.start&&this.options.timeField.end){this._startTimeIndex=new j;this._endTimeIndex=new j}else this.options.timeField&&(this._timeIndex=new j);this._cache={};this._currentSnapshot=[];this._activeRequests=0},onAdd:function(t){d(t);this.service.metadata((function(e,i){if(!e){var s=i.supportedQueryFormats;var r=false;(this.service.options.isModern===false||this.options.fetchAllFeatures)&&(r=true);!r&&s&&s.indexOf("geoJSON")!==-1&&(this.service.options.isModern=true);i.objectIdField&&(this.service.options.idAttribute=i.objectIdField);if(!this.options.attribution&&t.attributionControl&&i.copyrightText){this.options.attribution=i.copyrightText;t.attributionControl.addAttribution(this.getAttribution())}}}),this);t.on("zoomend",this._handleZoomChange,this);return at.prototype.onAdd.call(this,t)},onRemove:function(t){v(t);t.off("zoomend",this._handleZoomChange,this);return at.prototype.onRemove.call(this,t)},getAttribution:function(){return this.options.attribution},createCell:function(t,e){this._visibleZoom()&&this._requestFeatures(t,e)},_requestFeatures:function(t,e,i,s){this._activeRequests++;s=s||0;var r=this.options.where;this._activeRequests===1&&this.fire("loading",{bounds:t},true);return this._buildQuery(t,s).run((function(o,n,a){a&&a.exceededTransferLimit&&this.fire("drawlimitexceeded");if(this.options.where===r){!o&&n&&n.features.length&&g.requestAnimFrame(g.bind((function(){this._addFeatures(n.features,e);this._postProcessFeatures(t)}),this));o||!n||n.features.length||this._postProcessFeatures(t);o&&this._postProcessFeatures(t);i&&i.call(this,o,n);a&&(a.exceededTransferLimit||a.properties&&a.properties.exceededTransferLimit)&&this.options.fetchAllFeatures&&this._requestFeatures(t,e,i,s+n.features.length)}}),this)},_postProcessFeatures:function(t){this._activeRequests--;this._activeRequests<=0&&this.fire("load",{bounds:t})},_cacheKey:function(t){return t.z+":"+t.x+":"+t.y},_addFeatures:function(t,e){if(e){var i=this._cacheKey(e);this._cache[i]=this._cache[i]||[]}for(var s=t.length-1;s>=0;s--){var r=t[s].id;this._currentSnapshot.indexOf(r)===-1&&this._currentSnapshot.push(r);typeof i!=="undefined"&&this._cache[i].indexOf(r)===-1&&this._cache[i].push(r)}this.options.timeField&&this._buildTimeIndexes(t);this.createLayers(t)},_buildQuery:function(t,e){var i=this.service.query().intersects(t).where(this.options.where).fields(this.options.fields).precision(this.options.precision);this.options.fetchAllFeatures&&!isNaN(parseInt(e))&&(i=i.offset(e));i.params.resultType="tile";this.options.requestParams&&g.extend(i.params,this.options.requestParams);this.options.simplifyFactor&&i.simplify(this._map,this.options.simplifyFactor);this.options.timeFilterMode==="server"&&this.options.from&&this.options.to&&i.between(this.options.from,this.options.to);return i},setWhere:function(t,e,i){this.options.where=t&&t.length?t:"1=1";var s=[];var r=[];var o=0;var n=null;var a=g.bind((function(a,l){a&&(n=a);if(l)for(var h=l.features.length-1;h>=0;h--)r.push(l.features[h].id);o--;if(o<=0&&this._visibleZoom()&&t===this.options.where){this._currentSnapshot=r;g.requestAnimFrame(g.bind((function(){this.removeLayers(s);this.addLayers(r);e&&e.call(i,n)}),this))}}),this);for(var l=this._currentSnapshot.length-1;l>=0;l--)s.push(this._currentSnapshot[l]);this._cache={};for(var h in this._cells){o++;var u=this._keyToCellCoords(h);var p=this._cellCoordsToBounds(u);this._requestFeatures(p,u,a)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e,i,s){var r=this.options.from;var o=this.options.to;var n=0;var a=null;var l=g.bind((function(l){l&&(a=l);this._filterExistingFeatures(r,o,t,e);n--;i&&n<=0&&i.call(s,a)}),this);this.options.from=t;this.options.to=e;this._filterExistingFeatures(r,o,t,e);if(this.options.timeFilterMode==="server")for(var h in this._cells){n++;var u=this._keyToCellCoords(h);var p=this._cellCoordsToBounds(u);this._requestFeatures(p,u,l)}return this},refresh:function(){this.setWhere(this.options.where)},_filterExistingFeatures:function(t,e,i,s){var r=t&&e?this._getFeaturesInTimeRange(t,e):this._currentSnapshot;var o=this._getFeaturesInTimeRange(i,s);if(o.indexOf)for(var n=0;n<o.length;n++){var a=r.indexOf(o[n]);a>=0&&r.splice(a,1)}g.requestAnimFrame(g.bind((function(){this.removeLayers(r);this.addLayers(o)}),this))},_getFeaturesInTimeRange:function(t,e){var i=[];var s;if(this.options.timeField.start&&this.options.timeField.end){var r=this._startTimeIndex.between(t,e);var o=this._endTimeIndex.between(t,e);s=r.concat(o)}else{if(!this._timeIndex){h("You must set timeField in the layer constructor in order to manipulate the start and end time filter.");return[]}s=this._timeIndex.between(t,e)}for(var n=s.length-1;n>=0;n--)i.push(s[n].id);return i},_buildTimeIndexes:function(t){var e;var i;if(this.options.timeField.start&&this.options.timeField.end){var s=[];var r=[];for(e=t.length-1;e>=0;e--){i=t[e];s.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])});r.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])})}this._startTimeIndex.bulkAdd(s);this._endTimeIndex.bulkAdd(r)}else{var o=[];for(e=t.length-1;e>=0;e--){i=t[e];o.push({id:i.id,value:new Date(i.properties[this.options.timeField])})}this._timeIndex.bulkAdd(o)}},_featureWithinTimeRange:function(t){if(!this.options.from||!this.options.to)return true;var e=+this.options.from.valueOf();var i=+this.options.to.valueOf();if(typeof this.options.timeField==="string"){var s=+t.properties[this.options.timeField];return s>=e&&s<=i}if(this.options.timeField.start&&this.options.timeField.end){var r=+t.properties[this.options.timeField.start];var o=+t.properties[this.options.timeField.end];return r>=e&&r<=i||o>=e&&o<=i||r<=e&&o>=i}},_visibleZoom:function(){if(!this._map)return false;var t=this._map.getZoom();return!(t>this.options.maxZoom||t<this.options.minZoom)},_handleZoomChange:function(){if(this._visibleZoom())for(var t in this._cells){var e=this._cells[t].coords;var i=this._cacheKey(e);this._cache[i]&&this.addLayers(this._cache[i])}else{this.removeLayers(this._currentSnapshot);this._currentSnapshot=[]}},authenticate:function(t){this.service.authenticate(t);return this},metadata:function(t,e){this.service.metadata(t,e);return this},query:function(){return this.service.query()},_getMetadata:function(t){if(this._metadata){var e;t(e,this._metadata)}else this.metadata(g.bind((function(e,i){this._metadata=i;t(e,this._metadata)}),this))},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,e,i){this._getMetadata(g.bind((function(s,r){if(s)e&&e.call(this,s,null);else{var o=t.features?t.features:[t];this.service.addFeatures(t,g.bind((function(t,s){if(!t){for(var n=o.length-1;n>=0;n--){o[n].properties[r.objectIdField]=o.length>1?s[n].objectId:s.objectId;o[n].id=o.length>1?s[n].objectId:s.objectId}this._addFeatures(o)}e&&e.call(i,t,s)}),this))}}),this))},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var s=t.features?t.features:[t];this.service.updateFeatures(t,(function(t,r){if(!t){for(var o=s.length-1;o>=0;o--)this.removeLayers([s[o].id],true);this._addFeatures(s)}e&&e.call(i,t,r)}),this)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.service.deleteFeatures(t,(function(t,s){var r=s.length?s:[s];if(!t&&r.length>0)for(var o=r.length-1;o>=0;o--)this.removeLayers([r[o].objectId],true);e&&e.call(i,t,s)}),this)}});var ht=lt.extend({options:{cacheLayers:true},initialize:function(t){t.apikey&&(t.token=t.apikey);lt.prototype.initialize.call(this,t);this._originalStyle=this.options.style;this._layers={}},onRemove:function(t){for(var e in this._layers){t.removeLayer(this._layers[e]);this.fire("removefeature",{feature:this._layers[e].feature,permanent:false},true)}return lt.prototype.onRemove.call(this,t)},createNewLayer:function(t){var e=Z.geometryToLayer(t,this.options);e&&(e.defaultOptions=e.options);return e},_updateLayer:function(t,e){var i=[];var s=this.options.coordsToLatLng||Z.coordsToLatLng;e.properties&&(t.feature.properties=e.properties);switch(e.geometry.type){case"Point":i=Z.coordsToLatLng(e.geometry.coordinates);t.setLatLng(i);break;case"LineString":i=Z.coordsToLatLngs(e.geometry.coordinates,0,s);t.setLatLngs(i);break;case"MultiLineString":i=Z.coordsToLatLngs(e.geometry.coordinates,1,s);t.setLatLngs(i);break;case"Polygon":i=Z.coordsToLatLngs(e.geometry.coordinates,1,s);t.setLatLngs(i);break;case"MultiPolygon":i=Z.coordsToLatLngs(e.geometry.coordinates,2,s);t.setLatLngs(i);break}this.redraw(t.feature.id)},createLayers:function(t){for(var e=t.length-1;e>=0;e--){var i=t[e];var s=this._layers[i.id];var r;if(this._visibleZoom()&&s&&!this._map.hasLayer(s)&&(!this.options.timeField||this._featureWithinTimeRange(i))){this._map.addLayer(s);this.fire("addfeature",{feature:s.feature},true)}s&&(s.setLatLngs||s.setLatLng)&&this._updateLayer(s,i);if(!s){r=this.createNewLayer(i);if(r){r.feature=i;r.addEventParent(this);this.options.onEachFeature&&this.options.onEachFeature(r.feature,r);this._layers[r.feature.id]=r;this.setFeatureStyle(r.feature.id,this.options.style);this.fire("createfeature",{feature:r.feature},true);this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(i))&&this._map.addLayer(r)}else h("invalid GeoJSON encountered")}}},addLayers:function(t){for(var e=t.length-1;e>=0;e--){var i=this._layers[t[e]];if(i&&(!this.options.timeField||this._featureWithinTimeRange(i.feature))){this._map.addLayer(i);this.fire("addfeature",{feature:i.feature},true)}}},removeLayers:function(t,e){for(var i=t.length-1;i>=0;i--){var s=t[i];var r=this._layers[s];if(r){this.fire("removefeature",{feature:r.feature,permanent:e},true);this._map.removeLayer(r)}r&&e&&delete this._layers[s]}},cellEnter:function(t,e){this._visibleZoom()&&!this._zooming&&this._map&&g.requestAnimFrame(g.bind((function(){var t=this._cacheKey(e);var i=this._cellCoordsToKey(e);var s=this._cache[t];this._activeCells[i]&&s&&this.addLayers(s)}),this))},cellLeave:function(t,e){this._zooming||g.requestAnimFrame(g.bind((function(){if(this._map){var t=this._cacheKey(e);var i=this._cellCoordsToKey(e);var s=this._cache[t];var r=this._map.getBounds();if(!this._activeCells[i]&&s){var o=true;for(var n=0;n<s.length;n++){var a=this._layers[s[n]];a&&a.getBounds&&r.intersects(a.getBounds())&&(o=false)}o&&this.removeLayers(s,!this.options.cacheLayers);if(!this.options.cacheLayers&&o){delete this._cache[t];delete this._cells[i];delete this._activeCells[i]}}}}),this))},resetStyle:function(){this.options.style=this._originalStyle;this.eachFeature((function(t){this.resetFeatureStyle(t.feature.id)}),this);return this},setStyle:function(t){this.options.style=t;this.eachFeature((function(e){this.setFeatureStyle(e.feature.id,t)}),this);return this},resetFeatureStyle:function(t){var e=this._layers[t];var i=this._originalStyle||B.prototype.options;if(e){g.extend(e.options,e.defaultOptions);this.setFeatureStyle(t,i)}return this},setFeatureStyle:function(t,e){var i=this._layers[t];typeof e==="function"&&(e=e(i.feature));i.setStyle&&i.setStyle(e);return this},eachActiveFeature:function(t,e){if(this._map){var i=this._map.getBounds();for(var s in this._layers)this._currentSnapshot.indexOf(this._layers[s].feature.id)!==-1&&(typeof this._layers[s].getLatLng==="function"&&i.contains(this._layers[s].getLatLng())||typeof this._layers[s].getBounds==="function"&&i.intersects(this._layers[s].getBounds()))&&t.call(e,this._layers[s])}return this},eachFeature:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getFeature:function(t){return this._layers[t]},bringToBack:function(){this.eachFeature((function(t){t.bringToBack&&t.bringToBack()}))},bringToFront:function(){this.eachFeature((function(t){t.bringToFront&&t.bringToFront()}))},redraw:function(t){t&&this._redraw(t);return this},_redraw:function(t){var e=this._layers[t];var i=e.feature;if(e&&e.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var s=this.options.pointToLayer(i,b(i.geometry.coordinates[1],i.geometry.coordinates[0]));var r=s.options.icon;e.setIcon(r)}if(e&&e.setStyle&&this.options.pointToLayer){var o=this.options.pointToLayer(i,b(i.geometry.coordinates[1],i.geometry.coordinates[0]));var n=o.options;this.setFeatureStyle(i.id,n)}e&&e.setStyle&&this.options.style&&this.resetFeatureStyle(i.id)},openPopup(t){this._popup&&this._popup._prepareOpen(t||this._latlng)&&this._popup.openOn(this._map);return this},openTooltip(t){if(this._tooltip&&this._tooltip._prepareOpen(t)){this._tooltip.openOn(this._map);this.getElement?this._setAriaDescribedByOnLayer(this):this.eachLayer&&this.eachLayer(this._setAriaDescribedByOnLayer,this)}return this}});function featureLayer(t){return new ht(t)}var ut=U.version;export{et as BasemapLayer,nt as DynamicMapLayer,ht as FeatureLayer,$ as FeatureLayerService,lt as FeatureManager,V as Find,Q as Identify,J as IdentifyFeatures,K as IdentifyImage,ot as ImageMapLayer,Y as ImageService,H as MapService,W as Query,rt as RasterLayer,X as Service,N as Task,it as TiledMapLayer,ut as VERSION,basemapLayer,dynamicMapLayer,featureLayer,featureLayerService,find,identify,identifyFeatures,identifyImage,imageMapLayer,imageService,mapService,query,service,task,tiledMapLayer};

